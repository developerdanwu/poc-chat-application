// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-kysely"
}

datasource db {
  provider     = "postgresql"
  // NOTE: When using postgresql, mysql or sqlserver, uncomment the @db.Text annotations in model Account below
  // Further reading:
  // https://next-auth.js.org/adapters/prisma#create-the-prisma-schema
  // https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string
  url          = env("DATABASE_URL_NON_POOLED")
  relationMode = "foreignKeys"
}

enum ChatroomType {
  HUMAN_CHATROOM
  AI_CHATROOM
}

enum MessageType {
  MESSAGE
  AI_RESPONSE
}

enum MessageStatus {
  QUEUED
  SENT
  DELIVERED
  READ
  FAILED
}

enum MessageVisibility {
  ME
  ALL
}

enum Role {
  USER
  AI
}

enum AiModel {
  OPENAI
}

model Message {
  clientMessageId Int               @id @default(autoincrement()) @map("client_message_id")
  text            String            @db.Text
  type            MessageType
  content         String            @db.Text
  authorId        Int               @map("author_id")
  author          Author            @relation(fields: [authorId], references: [authorId])
  chatroomId      String            @map("chatroom_id")
  chatroom        Chatroom          @relation(fields: [chatroomId], references: [id], onDelete: Cascade)
  createdAt       DateTime          @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt       DateTime          @updatedAt @map("updated_at") @db.Timestamptz(3)
  isEdited        Boolean           @default(false) @map("is_edited")
  status          MessageStatus
  visibility      MessageVisibility

  @@index([authorId])
  @@index([chatroomId])
  @@map("message")
}

model OpenAiSettings {
  id          Int         @id @default(autoincrement()) @map("id")
  temperature Float?      @default(0) @map("temperature")
  AiSettings  AiSettings?

  @@map("open_ai_settings")
}

model AiSettings {
  id               Int             @id @default(autoincrement()) @map("id")
  model            AiModel
  author           Author          @relation(fields: [authorId], references: [authorId])
  authorId         Int             @unique @map("author_id")
  openAiSettingsId Int?            @unique @map("open_ai_settings_id")
  openAiSettings   OpenAiSettings? @relation(fields: [openAiSettingsId], references: [id])

  @@map("ai_settings")
}

model Author {
  firstName   String               @map("first_name")
  lastName    String               @map("last_name")
  email       String?              @unique
  authorId    Int                  @id @default(autoincrement()) @map("author_id")
  role        Role                 @map("role")
  userId      String?              @unique @map("user_id")
  messages    Message[]
  chatrooms   AuthorsOnChatrooms[]
  createdAt   DateTime             @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt   DateTime             @updatedAt @map("updated_at") @db.Timestamptz(3)
  aiUsers     Author[]             @relation("HumanUserAIUsers")
  humanUser   Author?              @relation("HumanUserAIUsers", fields: [humanUserId], references: [authorId])
  humanUserId Int?                 @map("human_user_id")
  aiSettings  AiSettings?

  @@index([authorId])
  @@map("author")
}

model AuthorsOnChatrooms {
  author     Author   @relation(fields: [authorId], references: [authorId])
  authorId   Int      @map("author_id")
  chatroom   Chatroom @relation(fields: [chatroomId], references: [id])
  chatroomId String   @map("chatroom_id")

  @@id([authorId, chatroomId])
  @@index([chatroomId])
  @@index([authorId])
  @@map("_authors_on_chatrooms")
}

model Chatroom {
  id        String               @id @default(dbgenerated("uuid_generate_v4()"))
  messages  Message[]
  type      ChatroomType
  createdAt DateTime             @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt DateTime             @updatedAt @map("updated_at") @db.Timestamptz(3)
  authors   AuthorsOnChatrooms[]

  @@map("chatroom")
}
